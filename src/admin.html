<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Login Section -->
    <div class="login-container">
        <div class="login-box">
            <h1>Admin Login</h1>
            <form class="login-form">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" placeholder="Enter your password" required>
                </div>
                <button type="submit" class="btn-login">Sign In</button>
            </form>
        </div>
    </div>

    <!-- Dashboard Section -->
    <div class="dashboard hidden">
        <!-- Header -->
        <header class="header">
            <nav>
                <div class="logo">
                    <img src="https://via.placeholder.com/40" alt="Logo">
                    <span>Admin Panel</span>
                </div>
                <ul class="nav-links">
                    <li><a href="#" class="active">Dashboard</a></li>
                    <li><a href="#">Reports</a></li>
                    <li><a href="#" id="logout">Logout</a></li>
                </ul>
            </nav>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Events Section -->
            <section class="content-section">
                <div class="section-header">
                    <h2>Events</h2>
                    <button class="btn-toggle">Toggle Form</button>
                </div>
                <div class="section-content">
                    <form class="admin-form">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="title">Title</label>
                                <input type="text" id="title" placeholder="Enter title">
                            </div>
                            <div class="form-group">
                                <label for="post_image">Poster</label>
                                <input type="file" id="post_image">
                            </div>
                            <div class="form-group full-width">
                                <label for="post_content">Short Description</label>
                                <textarea id="post_content" rows="2" placeholder="Short Description"></textarea>
                            </div>
                            <div class="form-group full-width">
                                <label for="post2_content">Long Description</label>
                                <textarea id="post2_content" rows="3" placeholder="Long Description"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="date">Date</label>
                                <input type="date" id="date">
                            </div>
                            <div class="form-group">
                                <label for="venue">Venue</label>
                                <input type="text" id="venue" placeholder="Enter Venue">
                            </div>
                            <div class="form-group">
                                <label for="prerequists">Pre-requisites</label>
                                <textarea id="prerequists" rows="2" placeholder="Pre-requisites"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="fee">Fee</label>
                                <input type="text" id="fee" placeholder="Enter Fee">
                            </div>
                            <div class="form-group">
                                <label for="time">Time</label>
                                <input type="text" id="time" placeholder="Enter Time">
                            </div>
                            <div class="form-group">
                                <label for="cName">Club Name</label>
                                <input type="text" id="cName" placeholder="Club Name">
                            </div>
                            <div class="form-group">
                                <label for="department">Department</label>
                                <select id="department">
                                    <option value="AI&ML">AI&ML</option>
                                    <option value="ECE">ECE</option>
                                    <option value="CSE">CSE</option>
                                    <option value="Mechanical">Mechanical</option>
                                    <option value="Civil">Civil</option>
                                    <option value="Electrical">Electrical</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="outcome">Outcome</label>
                                <input type="text" id="outcome" placeholder="Outcome">
                            </div>
                            <div class="form-group">
                                <label for="number1">Phone Number 1</label>
                                <input type="tel" id="number1" placeholder="Number 1">
                            </div>
                            <div class="form-group">
                                <label for="number2">Phone Number 2</label>
                                <input type="tel" id="number2" placeholder="Number 2">
                            </div>
                            <div class="form-group">
                                <label for="link1">Registration Link</label>
                                <input type="url" id="link1" placeholder="Registration link">
                            </div>
                            <div class="form-group">
                                <label for="link2">Club Link</label>
                                <input type="url" id="link2" placeholder="Club link">
                            </div>
                            <div class="form-group">
                                <label for="category">Category</label>
                                <select id="category">
                                    <option value="Technical">Technical</option>
                                    <option value="Non-Technical">Non-Technical</option>
                                    <option value="Sports">Sports</option>
                                    <option value="Workshops">Workshops</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" id="post_btn" class="btn-submit">Post Now</button>
                            <button type="button" id="update_btn" class="btn-update">Update Post</button>
                        </div>
                    </form>
                    
                    <div class="table-container">
                        <h3>Event List</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Date</th>
                                    <th>Venue</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Table content will be dynamically populated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Announcements Section -->
            <section class="content-section">
                <div class="section-header">
                    <h2>Announcements</h2>
                    <button class="btn-toggle">Toggle Form</button>
                </div>
                <div class="section-content">
                    <form class="admin-form">
                        <div class="form-grid">
                            <div class="form-group full-width">
                                <label for="title2">Announcement</label>
                                <input type="text" id="title2" placeholder="Enter Announcement">
                            </div>
                            <div class="form-group">
                                <label for="colorPicker">Text Color</label>
                                <select id="colorPicker">
                                    <option value="white">White</option>
                                    <option value="black">Black</option>
                                    <option value="red">Red</option>
                                    <option value="green">Green</option>
                                    <option value="blue">Blue</option>
                                    <option value="blinking">Blinking (Red/White)</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" id="post_btn1" class="btn-submit">Post Now</button>
                            <button type="button" id="update_btn1" class="btn-update">Update Post</button>
                        </div>
                    </form>
                    
                    <div class="table-container">
                        <h3>Announcement List</h3>
                        <table class="data-table" id="announcement_table">
                            <thead>
                                <tr>
                                    <th>Announcement</th>
                                    <th>Color</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Table content will be dynamically populated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Timeline Section -->
            <section class="content-section">
                <div class="section-header">
                    <h2>Timeline</h2>
                    <button class="btn-toggle">Toggle Form</button>
                </div>
                <div class="section-content">
                    <form class="admin-form">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="title3">Title</label>
                                <input type="text" id="title3" placeholder="Enter title">
                            </div>
                            <div class="form-group image-upload-group">
                                <label>Images</label>
                                <div class="image-upload-container">
                                    <div class="image-upload">
                                        <input type="file" id="post_image2">
                                        <select id="category2">
                                            <option value="cover">Cover</option>
                                            <option value="fill">Fill</option>
                                            <option value="contain">Contain</option>
                                        </select>
                                    </div>
                                    <div class="image-upload">
                                        <input type="file" id="post_image3">
                                        <select id="category2">
                                            <option value="cover">Cover</option>
                                            <option value="fill">Fill</option>
                                            <option value="contain">Contain</option>
                                        </select>
                                    </div>
                                    <div class="image-upload">
                                        <input type="file" id="post_image4">
                                        <select id="category2">
                                            <option value="cover">Cover</option>
                                            <option value="fill">Fill</option>
                                            <option value="contain">Contain</option>
                                            <option value="cover">Cover2-350px</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" id="post_btn3" class="btn-submit">Post Now</button>
                            <button type="button" id="update_btn3" class="btn-update">Update Post</button>
                        </div>
                    </form>
                    
                    <div class="table-container">
                        <h3>Timeline Posts</h3>
                        <table class="data-table" id="timeline">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Images</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Table content will be dynamically populated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Sponsors Section -->
            <section class="content-section">
                <div class="section-header">
                    <h2>Sponsors</h2>
                    <button class="btn-toggle">Toggle Form</button>
                </div>
                <div class="section-content">
                    <form class="admin-form">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="title4">Title</label>
                                <input type="text" id="title4" placeholder="Enter title">
                            </div>
                            <div class="form-group">
                                <label for="post_image5">Poster</label>
                                <input type="file" id="post_image5">
                                <select id="category3">
                                    <option value="cover">Cover</option>
                                    <option value="fill">Fill</option>
                                    <option value="contain">Contain</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" id="post_btn4" class="btn-submit">Post Now</button>
                            <button type="button" id="update_btn4" class="btn-update">Update Post</button>
                        </div>
                    </form>
                    
                    <div class="table-container">
                        <h3>Sponsors List</h3>
                        <table class="data-table" id="Sponsors">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Image</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Table content will be dynamically populated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Clubs Section -->
            <section class="content-section">
                <div class="section-header">
                    <h2>Clubs</h2>
                    <button class="btn-toggle">Toggle Form</button>
                </div>
                <div class="section-content">
                    <form class="admin-form">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="Ctitle">Club Title</label>
                                <input type="text" id="Ctitle" placeholder="Enter club title">
                            </div>
                            <div class="form-group">
                                <label for="imageR">Main Image (Right)</label>
                                <input type="file" id="imageR">
                            </div>
                            <div class="form-group">
                                <label for="imageL">Main Image (Left)</label>
                                <input type="file" id="imageL">
                            </div>
                            <div class="form-group full-width">
                                <label for="description1">Short Description</label>
                                <textarea id="description1" rows="2" placeholder="Short description"></textarea>
                            </div>
                            <div class="form-group full-width">
                                <label for="description2">Detailed Description</label>
                                <textarea id="description2" rows="3" placeholder="Detailed description"></textarea>
                            </div>

                            <!-- Activities Section -->
                            <div class="form-group full-width">
                                <h4 class="subsection-title">Activities</h4>
                                <div class="activities-container">
                                    <!-- Activity 1 -->
                                    <div class="activity-group">
                                        <label for="act_title">Activity 1 Title</label>
                                        <input type="text" id="act_title" placeholder="Activity title">
                                        <label for="act_desc">Activity 1 Description</label>
                                        <textarea id="act_desc" placeholder="Activity description"></textarea>
                                        <input type="file" id="act1">
                                    </div>

                                    <!-- Activity 2 -->
                                    <div class="activity-group">
                                        <label for="act_title2">Activity 2 Title</label>
                                        <input type="text" id="act_title2" placeholder="Activity title">
                                        <label for="act_desc2">Activity 2 Description</label>
                                        <textarea id="act_desc2" placeholder="Activity description"></textarea>
                                        <input type="file" id="act2">
                                    </div>

                                    <!-- Activity 3 -->
                                    <div class="activity-group">
                                        <label for="act_title3">Activity 3 Title</label>
                                        <input type="text" id="act_title3" placeholder="Activity title">
                                        <label for="act_desc3">Activity 3 Description</label>
                                        <textarea id="act_desc3" placeholder="Activity description"></textarea>
                                        <input type="file" id="act3">
                                    </div>
                                </div>
                            </div>

                            <!-- Gallery Section -->
                            <div class="form-group full-width">
                                <h4 class="subsection-title">Gallery Images (8 images)</h4>
                                <div class="gallery-grid">
                                    <input type="file" id="gal1">
                                    <input type="file" id="gal2">
                                    <input type="file" id="gal3">
                                    <input type="file" id="gal4">
                                    <input type="file" id="gal5">
                                    <input type="file" id="gal6">
                                    <input type="file" id="gal7">
                                    <input type="file" id="gal8">
                                </div>
                            </div>

                            <!-- Contact Details -->
                            <div class="form-group">
                                <label for="reach_out">Reach Out Text</label>
                                <input type="text" id="reach_out" placeholder="Reach out message">
                            </div>
                            <div class="form-group">
                                <label for="Cnumber1">Primary Phone</label>
                                <input type="tel" id="Cnumber1" placeholder="Primary number">
                            </div>
                            <div class="form-group">
                                <label for="Cnumber2">Secondary Phone</label>
                                <input type="tel" id="Cnumber2" placeholder="Secondary number">
                            </div>
                            <div class="form-group">
                                <label for="instaURL">Instagram URL</label>
                                <input type="url" id="instaURL" placeholder="Instagram URL">
                            </div>
                            <div class="form-group">
                                <label for="insta_id">Instagram Handle</label>
                                <input type="text" id="insta_id" placeholder="Instagram Handle">
                            </div>
                            <div class="form-group">
                                <label for="Email">Email</label>
                                <input type="email" id="Email" placeholder="Club email">
                            </div>
                            <div class="form-group">
                                <label for="poster">Club Poster</label>
                                <input type="file" id="poster">
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" id="club_post_btn" class="btn-submit">Create Club</button>
                            <button type="button" id="club_update_btn" class="btn-update">Update Club</button>
                        </div>
                    </form>
                    
                    <div class="table-container">
                        <h3>Clubs List</h3>
                        <table class="data-table" id="clubs_table">
                            <thead>
                                <tr>
                                    <th>Club Name</th>
                                    <th>Email</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Table content will be dynamically populated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <h4>About Us</h4>
            <p>You Plan, We gather! <br>Our club deals with Organising, Conducting and Organising events</p>
            <div class="social-links">
                <a href="https://www.instagram.com/" target="_blank" class="social-link">Instagram</a>
                <a href="#" class="social-link">Discord</a>
                <span class="social-link">Phone</span>
                <span class="social-link">Location</span>
            </div>
            <p class="copyright">Made with ♥ by CultFiesta</p>
        </footer>
    </div>

    <script>
        // Toggle section content
        document.querySelectorAll('.btn-toggle').forEach(button => {
            button.addEventListener('click', () => {
                const content = button.closest('.content-section').querySelector('.section-content');
                content.style.display = content.style.display === 'none' ? 'block' : 'none';
            });
        });
    </script>

      <script type="module" >// Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
        import { getDatabase, set, ref, get, remove, update } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-storage.js";
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyClkiHJX3mR4SdQQ2jzuG-n7ZNzuYD2REE",
          authDomain: "dbms-d5864.firebaseapp.com",
          projectId: "dbms-d5864",
          storageBucket: "dbms-d5864.appspot.com",
          messagingSenderId: "478043315963",
          appId: "1:478043315963:web:02a9cd2c70c4755bce5a5e",
          measurementId: "G-W7EKCZXJ0J"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const storage = getStorage(app);
        
        const my_blog = document.querySelector('.my_blog');
        const login_page = document.querySelector('.login');
        const notify = document.querySelector('.notify');
        const add_post_btn = document.querySelector('#post_btn');
        const update_btn = document.querySelector('.update_btn');
        
        // Admin UID and Regular User UIDs with names
        const adminUID = {'QkNkwVJ8eva41VrDFcyvJxlQwLl1': 'ADMIN'} ;  // Admin UID
        const users = {
          'wthrtDIUGUVvzyw4PC1M6rZXOY63': 'CSE',
          'quZ07wePADe95oEStgNQAZQXsz43': 'DS',
          '7EOyN1WeuGVIBIDBFPRrn0ShQLk1': 'AI&ML',
          'g2vEL3fTo4dokz2T69Vc3YjHoHD3': 'ECE',
          '6JnzSPiYLSbpVaxFmQ3KT0IVvJ93': 'Mechanical',
          'UWLCuim8pQYzRKhO978TlZ3B1y93': 'CY',
          '1TfsefP3v5SxSLwh3TZMn2j6JVA2': 'Civil',
          'Ko1YNqBbuQhKYyNtVGuBUeU14Je2': 'ISE',
          'JgEwgOBp9ASpkEbCgGSFfomTPQ92': 'EEE'




          



        }; // Regular User UIDs and names
        
        onAuthStateChanged(auth, (user) => {
          if (user) {
            my_blog.classList.add('show');
            login_page.classList.add('hide');
          } else {
            my_blog.classList.remove('show');
            login_page.classList.remove('hide');
          }
        });
        
        function SignInUser(event) {
          event.preventDefault();  // Prevent default form submission
          const email = document.getElementById('email').value;
          const password = document.getElementById('password').value;
          signInWithEmailAndPassword(auth, email, password)
            .then((userCredentials) => {
              console.log(userCredentials.user.uid);
            })
            .catch((error) => {
              console.error("Sign in error: ", error);
            });
        }
        
        const sign_btn = document.querySelector('#sign_in');
        sign_btn.addEventListener('click', SignInUser);
        
        const sign_out_btn = document.querySelector('#logout');
        sign_out_btn.addEventListener('click', () => {
          signOut(auth).then(() => {
            notify.innerHTML = "Signed out successfully";
            setTimeout(() => {
              location.reload();
            }, 2000);
          }).catch((error) => {
            console.log("Sign out error: ", error);
          });
        });
        
        // Modify Add_Post function to include user UID and selected category
        function LogPostDetails(id,department, cName, date, category) {
    const logRef = ref(db, `logs/${id}`);
    set(logRef, {
        
        department: department,
        club: cName, // Log cName as club
        date: date,
        category: category

    }).then(() => {
        console.log("Post details logged successfully.");
    }).catch((error) => {
        console.error("Error logging post details: ", error);
    });
}

// Function to Add a New Post
function Add_Post() {
    const title = document.querySelector('#title').value;
    const post_content = document.querySelector('#post_content').value;
    const post2_content = document.querySelector('#post2_content').value;
    const post_image = document.querySelector('#post_image').files[0];
    const date = document.querySelector('#date').value;
    const venue = document.querySelector('#venue').value;
    const prerequists = document.querySelector('#prerequists').value;
    const fee = document.querySelector('#fee').value;
    const time = document.querySelector('#time').value;
    const cName = document.querySelector('#cName').value;
    const outcome = document.querySelector('#outcome').value;
    const number1 = document.querySelector('#number1').value;
    const number2 = document.querySelector('#number2').value;
    const link1 = document.querySelector('#link1').value;
    const link2 = document.querySelector('#link2').value;
    const category = document.querySelector('#category').value;
    const department = document.querySelector('#department').value; // Get selected category from dropdown

    const user = auth.currentUser; // Get the logged-in user

    if (!user) {
        alert("You must be logged in to add a post.");
        return;
    }

    if (!post_image) {
        alert("Please select an image");
        return;
    }

    const id = Date.now();
    const imageRef = storageRef(storage, `images/${id}-${post_image.name}`);

    uploadBytes(imageRef, post_image).then((snapshot) => {
        return getDownloadURL(snapshot.ref);
    }).then((downloadURL) => {
        return set(ref(db, 'post/' + id), {
            title: title,
            post_content: post_content,
            post2_content: post2_content,
            imageURL: downloadURL,
            date: date,
            venue: venue,
            prerequists: prerequists,
            fee: fee,
            time: time,
            cName: cName,
            outcome: outcome,
            number1: number1,
            number2: number2,
            link1: link1,
            link2: link2,
            category: category,
            department: department,
            uid: user.uid // Store the UID of the user creating the post
        });
    }).then(() => {
        // Log post details separately
        LogPostDetails(id, department, cName, date, category);

        notify.innerHTML = "Data Added";
        clearFields();
        GetPostData();
    }).catch((error) => {
        console.error("Error uploading file: ", error);
        notify.innerHTML = "Error adding data";
    });
}

add_post_btn.addEventListener('click', Add_Post);

// Function to Clear Input Fields
function clearFields() {
    document.querySelector('#title').value = "";
    document.querySelector('#post_content').value = "";
    document.querySelector('#post2_content').value = "";
    document.querySelector('#post_image').value = "";
    document.querySelector('#date').value = "";
    document.querySelector('#venue').value = "";
    document.querySelector('#prerequists').value = "";
    document.querySelector('#fee').value = "";
    document.querySelector('#time').value = "";
    document.querySelector('#cName').value = "";
    document.querySelector('#outcome').value = "";
    document.querySelector('#number1').value = "";
    document.querySelector('#number2').value = "";
    document.querySelector('#link1').value = "";
    document.querySelector('#link2').value = "";
    document.querySelector('#category').value = "";
    document.querySelector('#department').value = "";
    // Removed: document.querySelector('#club').value = ""; // No longer needed
}

// Function to Retrieve and Display Posts
function GetPostData() {
    const user_ref = ref(db, 'post/');
    get(user_ref).then((snapshot) => {
        const data = snapshot.val();
        let html = "";
        const table = document.querySelector('table');

        for (const key in data) {
            const { title, post_content, post2_content, imageURL, uid } = data[key];
            const username = users[uid] || "ADMIN"; // Get username or default to "Unknown User"

            html += `
            <tr>
                <td><span class="postNumber"></span></td>
                <td class="separator">
                    <div><b>${title}</b> by <i>${username}</i></div>
                    <img src="${imageURL}" alt="Post Image" style="width:100px;height:100px;">
                </td>
                <td class="separator">
                    <button class="delete" onclick="delete_data('${key}', '${uid}')">Delete</button>
                </td>
                <td class="separator">
                    <button class="update" onclick="update_data('${key}', '${uid}')">Update</button>
                </td>
                <td class="separator">
                    <a href="../events/index.html?id=${key}" class="details">View Details</a>
                </td>
            </tr>`;
        }

        table.innerHTML = html;
    }).catch((error) => {
        console.error("Error fetching posts: ", error);
        notify.innerHTML = "Error fetching posts";
    });
}

GetPostData();

// Function to Delete a Post
window.delete_data = function (key, postUID) {
    const user = auth.currentUser;

    if (!user) {
        alert("You must be logged in to delete a post.");
        return;
    }

    if (adminUID[user.uid] || user.uid === postUID) { // Admin or owner can delete
        const post_ref = ref(db, `post/${key}`);

        get(post_ref).then((snapshot) => {
            if (!snapshot.exists()) {
                alert("Post does not exist.");
                return;
            }

            const data = snapshot.val();
            const imageURL = data.imageURL;

            // Remove the post data
            remove(post_ref).then(() => {
                // Extract the image path from the imageURL
                const storagePath = decodeURIComponent(imageURL.split('/o/')[1].split('?')[0]);
                const imageRef = storageRef(storage, storagePath);
                return deleteObject(imageRef);
            }).then(() => {
                notify.innerHTML = "Post and associated image deleted successfully";
                GetPostData();
            }).catch((error) => {
                console.error("Error deleting data: ", error);
                notify.innerHTML = "Error deleting post";
            });
        }).catch((error) => {
            console.error("Error fetching post data: ", error);
            notify.innerHTML = "Error fetching post data";
        });
    } else {
        alert("You can only delete posts created by you!");
    }
}

// Function to Update a Post
window.update_data = function (key, postUID) {
    const user = auth.currentUser;

    if (!user) {
        alert("You must be logged in to update a post.");
        return;
    }

    if (user.uid === adminUID || user.uid === postUID) { // Admin or owner can update
        update_btn.classList.remove('hide');
        add_post_btn.classList.add('hide');
        const post_ref = ref(db, `post/${key}`);
        get(post_ref).then((snapshot) => {
            if (!snapshot.exists()) {
                alert("Post does not exist.");
                return;
            }

            const data = snapshot.val();
            document.querySelector('#title').value = data.title;
            document.querySelector('#post_content').value = data.post_content;
            document.querySelector('#post2_content').value = data.post2_content;
            document.querySelector('#date').value = data.date;
            document.querySelector('#venue').value = data.venue;
            document.querySelector('#prerequists').value = data.prerequists;
            document.querySelector('#fee').value = data.fee;
            document.querySelector('#time').value = data.time;
            document.querySelector('#cName').value = data.cName;
            document.querySelector('#outcome').value = data.outcome;
            document.querySelector('#number1').value = data.number1;
            document.querySelector('#number2').value = data.number2;
            document.querySelector('#link1').value = data.link1;
            document.querySelector('#link2').value = data.link2;
            document.querySelector('#category').value = data.category; // Populate category field
            document.querySelector('#department').value = data.department;

            // Store the key for updating
            update_btn.setAttribute('data-key', key);
        }).catch((error) => {
            console.error("Error fetching post data: ", error);
            notify.innerHTML = "Error fetching post data";
        });
    } else {
        alert("You can only update posts created by you!");
    }
}

// Event Listener for Update Button
update_btn.addEventListener('click', () => {
    const key = update_btn.getAttribute('data-key');
    const title = document.querySelector('#title').value;
    const post_content = document.querySelector('#post_content').value;
    const post2_content = document.querySelector('#post2_content').value;
    const date = document.querySelector('#date').value;
    const venue = document.querySelector('#venue').value;
    const prerequists = document.querySelector('#prerequists').value;
    const fee = document.querySelector('#fee').value;
    const time = document.querySelector('#time').value;
    const cName = document.querySelector('#cName').value;
    const outcome = document.querySelector('#outcome').value;
    const number1 = document.querySelector('#number1').value;
    const number2 = document.querySelector('#number2').value;
    const link1 = document.querySelector('#link1').value;
    const link2 = document.querySelector('#link2').value;
    const category = document.querySelector('#category').value; // Get selected category from dropdown
    const department = document.querySelector('#department').value;
    // Removed: const club = document.querySelector('#club').value; // No longer needed

    const user = auth.currentUser; // Get the logged-in user

    if (!user) {
        alert("You must be logged in to update a post.");
        return;
    }

    const post_ref = ref(db, `post/${key}`);
    update(post_ref, {
        title: title,
        post_content: post_content,
        post2_content: post2_content,
        date: date,
        venue: venue,
        prerequists: prerequists,
        fee: fee,
        time: time,
        cName: cName,
        outcome: outcome,
        number1: number1,
        number2: number2,
        link1: link1,
        link2: link2,
        category: category, // Include selected category in the post data
        department: department,
        uid: user.uid // Update the UID of the user creating the post (if changed)
    }).then(() => {
        // After updating the post, also update the log if necessary
        // Optionally, you can update the logs here if any of the logged fields have changed

        notify.innerHTML = "Data Updated";
        clearFields();
        GetPostData();
        update_btn.classList.add('hide');
        add_post_btn.classList.remove('hide');
    }).catch((error) => {
        console.error("Error updating data: ", error);
        notify.innerHTML = "Error updating data";
    });
});

// -------------------------------------------
const add_post_Btn1 = document.querySelector('#post_btn1');
const update_btn1 = document.querySelector('#update_btn1');
let updateKey = null; // Initialize updateKey

// ============================ Announcement Features ============================ //

// Add Announcement Function
function Add_Announcement() {
  const title = document.querySelector('#title2').value;
  const color = document.querySelector('#colorPicker').value; // Get the selected color
  const user = auth.currentUser; // Get the logged-in user

  if (!title) {
    alert("Please enter a title for the announcement.");
    return;
  }

  const id = Date.now(); // Use Date.now() for unique identifier

  set(ref(db, 'announcement/' + id), {
    title: title,
    color: color, // Save the color in Firebase
    uid: user.uid // Store the UID of the user creating the announcement
  }).then(() => {
    notify.innerHTML = "Announcement Added Successfully";
    document.querySelector('#title2').value = "";
    document.querySelector('#colorPicker').value = "#ffffff"; // Reset color picker to default
    GetAnnounData();
  }).catch(error => {
    console.error("Error adding announcement: ", error);
    notify.innerHTML = "Error adding announcement";
  });
}

add_post_Btn1.addEventListener('click', Add_Announcement);

// Get Announcement Data Function
function GetAnnounData() {
  const announ_ref = ref(db, 'announcement/');
  get(announ_ref).then((snapshot) => {
    const data = snapshot.val();

    let html = "";
    const table = document.querySelector('#announcement_table');
    for (const key in data) {
      const { title, color, uid } = data[key];
      let textColorClass = '';
      switch (color) {
        case 'white':
          textColorClass = 'white';
          break;
        case 'green':
          textColorClass = 'green';
          break;
        case 'red':
          textColorClass = 'red';
          break;
        case 'blinking':
          textColorClass = 'blinking';
          break;
        default:
          textColorClass = ''; // or default color class
          break;
      }

      const username = (uid === adminUID) ? "ADMIN" : (users[uid] || "ADMIN");

      html += `
        <tr>
          <td><span class="postNumber"></span></td>
          <td class="${textColorClass}">${title} <br>  <small style="color: white;">by: ${username}</small></td>
          <td><button class="delete" onclick="delete_data1('${key}', '${uid}')">Delete</button></td>
          <td><button class="update" onclick="updateAnnouncement('${key}', '${uid}')">Update</button></td>
        </tr>
      `;
    }

    table.innerHTML = html;
  }).catch(error => {
    console.error("Error fetching announcements: ", error);
    notify.innerHTML = "Error fetching announcements";
  });
}

// Delete Announcement Function
window.delete_data1 = function (key, announUID) {
  const user = auth.currentUser;

  if (user.uid === adminUID || user.uid === announUID) { // Admin or owner can delete
    const announ_ref = ref(db, `announcement/${key}`);

    remove(announ_ref).then(() => {
      notify.innerHTML = "Announcement Deleted Successfully";
      GetAnnounData();
    }).catch(error => {
      console.error("Error deleting announcement: ", error);
      notify.innerHTML = "Error deleting announcement";
    });
  } else {
    alert("You can only delete announcements created by you!");
  }
};

// Update Announcement Function
window.updateAnnouncement = function (key, announUID) {
  const user = auth.currentUser;

  if (user.uid === adminUID || user.uid === announUID) { // Admin or owner can update
    update_btn1.classList.remove('hide');
    add_post_Btn1.classList.add('hide');
    const announ_ref = ref(db, `announcement/${key}`);
    get(announ_ref).then((snapshot) => {
      const data = snapshot.val();
      document.querySelector('#title2').value = data.title;
      const colorPicker = document.querySelector('#colorPicker');
      colorPicker.value = data.color; // Set color picker value
      updateKey = key;

      // Log color value just before updating database
      console.log("Color before update:", data.color);
    }).catch(error => {
      console.error("Error fetching announcement for update: ", error);
      notify.innerHTML = "Error fetching announcement data";
    });
  } else {
    alert("You can only update announcements created by you!");
  }
}

update_btn1.addEventListener('click', function () {
  const title = document.querySelector('#title2').value;
  const color = document.querySelector('#colorPicker').value; // Get selected color
  const user = auth.currentUser; // Get the logged-in user

  if (updateKey) {
    console.log("Color before update:", color); // Log color value before updating
    update(ref(db, `announcement/${updateKey}`), {
      title: title,
      color: color, // Update color value
      uid: user.uid // Update UID if necessary (typically, UID shouldn't change)
    }).then(() => {
      notify.innerHTML = "Announcement Updated Successfully";
      document.querySelector('#title2').value = "";
      document.querySelector('#colorPicker').value = "#ffffff"; // Reset color picker to default
      updateKey = null;
      update_btn1.classList.add('hide');
      add_post_Btn1.classList.remove('hide');
      GetAnnounData();
    }).catch(error => {
      console.error("Error updating announcement: ", error);
      notify.innerHTML = "Error updating announcement";
    });
  }
});

// Initial Data Load

GetAnnounData();

//  --------------------------------



// AddTime function to upload post data
function AddTime() {
  const title = document.querySelector('#title3').value;
  const post_image2 = document.querySelector('#post_image2').files[0];
  const post_image3 = document.querySelector('#post_image3').files[0];
  const post_image4 = document.querySelector('#post_image4').files[0];
  const category2 = document.querySelector('#category2').value;

  const user = auth.currentUser;
  if (!user) {
    alert("You must be logged in to add a post.");
    return;
  }

  if (!post_image2) {
    alert("Please select the first image");
    return;
  }

  const id = Date.now();

  const uploadImage = (file, id, idx) => {
    const imageRef = storageRef(storage, `timeline/${id}-${idx}-${file.name}`);
    return uploadBytes(imageRef, file).then(snapshot => getDownloadURL(snapshot.ref));
  };

  Promise.all([
    uploadImage(post_image2, id, 1),
    post_image3 ? uploadImage(post_image3, id, 2) : Promise.resolve(null),
    post_image4 ? uploadImage(post_image4, id, 3) : Promise.resolve(null)
  ]).then(urls => {
    const imageData = {
      imageURL1: urls[0],
      imageURL2: urls[1],
      imageURL3: urls[2]
    };

    return set(ref(db, 'timeline/' + id), {
      title: title,
      ...imageData,
      category: category2,
      userId: user.uid,  // Store user ID
      userName: user.displayName || "ADMIN"  // Optionally store the user’s name
    });
  }).then(() => {
    notify.innerHTML = "Data Added";
    clearFieldsTimeline();
    GetTimeData();
  }).catch((error) => {
    console.error("Error uploading file: ", error);
    notify.innerHTML = "Error adding data";
  });
}

// Bind AddTime function to the post button
document.querySelector('#post_btn3').addEventListener('click', AddTime);

// Clear form fields after data is added
function clearFieldsTimeline() {
  document.querySelector('#title3').value = "";
  document.querySelector('#post_image2').value = "";
  document.querySelector('#post_image3').value = "";
  document.querySelector('#post_image4').value = "";
  document.querySelector('#category2').value = "";
}

// Get timeline data and display in the table
function GetTimeData() {
  const user_ref = ref(db, 'timeline/');
  get(user_ref).then((snapshot) => {
    const data = snapshot.val();
    let html = "";
    const table = document.querySelector('#timeline');

    for (const key in data) {
      const { title, imageURL1, imageURL2, imageURL3, category, userName } = data[key];

      html += `
        <tr>
          <td><span class="postNumber"></span></td>
          <td class="separator">
            <div><b>${title}</b></div>
            <div>Added by: ${userName || "ADMIN"}</div>
            <img src="${imageURL1}" alt="Post Image 1" class="${category}" style="width:100px;height:100px;">
           
          </td>
          <td class="separator"><button class="delete" onclick="deleteTimeData('${key}')">Delete</button></td>
          <td class="separator"><button class="update" onclick="updateTimeData('${key}')">Update</button></td>
        </tr>
      `;
    }
    table.innerHTML = html;
  });
}

// Delete timeline data
window.deleteTimeData = function (key) {
  const user = auth.currentUser;
  if (!user) {
    alert("You must be logged in to delete a post.");
    return;
  }

  const user_ref = ref(db, `timeline/${key}`);
  get(user_ref).then((snapshot) => {
    const data = snapshot.val();
    if (!data) {
      notify.innerHTML = "Post not found";
      return;
    }

    // Check if the current user is the owner of the post
    if (data.userId !== user.uid) {
      alert("You can only delete your own posts.");
      return;
    }

    const imageRefs = [data.imageURL1, data.imageURL2, data.imageURL3].filter(Boolean).map(url => {
      const fileName = url.split('%2F').pop().split('?')[0];
      return storageRef(storage, `timeline/${fileName}`);
    });

    remove(user_ref).then(() => {
      return Promise.all(imageRefs.map(ref => deleteObject(ref)));
    }).then(() => {
      notify.innerHTML = "Post and associated images deleted successfully";
      GetTimeData();
    }).catch((error) => {
      console.error("Error deleting data: ", error);
      notify.innerHTML = "Error deleting post";
    });
  });
}

// Update timeline data
window.updateTimeData = function (key) {
  const user = auth.currentUser;
  if (!user) {
    alert("You must be logged in to update a post.");
    return;
  }

  const user_ref = ref(db, `timeline/${key}`);
  get(user_ref).then((item) => {
    const data = item.val();
    if (!data) {
      notify.innerHTML = "Post not found";
      return;
    }

    // Check if the current user is the owner of the post
    if (data.userId !== user.uid) {
      alert("You can only update your own posts.");
      return;
    }

    document.querySelector('#title3').value = data.title;
    document.querySelector('#category2').value = data.category;

    // Display update button and hide add button
    document.querySelector('#update_btn3').style.display = 'block';
    document.querySelector('#post_btn3').style.display = 'none';

    // Bind update functionality
    document.querySelector('#update_btn3').onclick = function() {
      updatePostData(key, data.imageURL1, data.imageURL2, data.imageURL3);
    };
  });
}

// Update post data logic
function updatePostData(key, oldImageURL1, oldImageURL2, oldImageURL3) {
  const title = document.querySelector('#title3').value;
  const post_image2 = document.querySelector('#post_image2').files[0];
  const post_image3 = document.querySelector('#post_image3').files[0];
  const post_image4 = document.querySelector('#post_image4').files[0];
  const category2 = document.querySelector('#category2').value;

  const deleteOldImage = (url) => {
    if (!url) return Promise.resolve();
    const fileName = url.split('%2F').pop().split('?')[0];
    const oldImageRef = storageRef(storage, `timeline/${fileName}`);
    return deleteObject(oldImageRef);
  };

  const uploadImage = (file, id, idx) => {
    const imageRef = storageRef(storage, `timeline/${id}-${idx}-${file.name}`);
    return uploadBytes(imageRef, file).then(snapshot => getDownloadURL(snapshot.ref));
  };

  const promises = [
    post_image2 ? deleteOldImage(oldImageURL1).then(() => uploadImage(post_image2, key, 1)) : Promise.resolve(oldImageURL1),
    post_image3 ? deleteOldImage(oldImageURL2).then(() => uploadImage(post_image3, key, 2)) : Promise.resolve(oldImageURL2),
    post_image4 ? deleteOldImage(oldImageURL3).then(() => uploadImage(post_image4, key, 3)) : Promise.resolve(oldImageURL3)
  ];

  Promise.all(promises).then(urls => {
    return update(ref(db, `timeline/${key}`), {
      title: title,
      imageURL1: urls[0],
      imageURL2: urls[1],
      imageURL3: urls[2],
      category: category2
    });
  }).then(() => {
    notify.innerHTML = "Post updated successfully";
    clearFieldsTimeline();
    GetTimeData();
  }).catch((error) => {
    console.error("Error updating post: ", error);
    notify.innerHTML = "Error updating post";
  });

  document.querySelector('#update_btn3').style.display = 'none';
  document.querySelector('#post_btn3').style.display = 'block';
}

// Initial call to load timeline data
GetTimeData();

/* _-------------------------------- */

// Function to add a new sponsor
function AddSponsor() {
    const title = document.querySelector('#title4').value;
    const post_image5 = document.querySelector('#post_image5').files[0]; // Changed to post_image5
    const category3 = document.querySelector('#category3').value;

    const currentUser = auth.currentUser; // Get the current user
    console.log("Current User:", currentUser); // Debugging statement

    if (!currentUser) {
        alert("You must be logged in to add a post.");
        return;
    }

    // Fetching the userName based on the UID
    const userName = users[currentUser.uid] || "Anonymous"; // Get the user name
    console.log("User Name:", userName); // Debugging statement

    if (!post_image5) {
        alert("Please select an image");
        return;
    }

    const id = Date.now();
    const imageRef5 = storageRef(storage, `sponsors/${id}-${post_image5.name}`);

    uploadBytes(imageRef5, post_image5).then((snapshot) => {
        return getDownloadURL(snapshot.ref);
    }).then((downloadURL) => {
        return set(ref(db, 'sponsors/' + id), {
            title: title,
            imageURL: downloadURL,
            category: category3,
            userId: currentUser.uid,
            userName: userName // Store the correct userName
        });
    }).then(() => {
        notify.innerHTML = "Sponsor Added Successfully";
        clearFieldsSponsors();
        GetSponsorData();
    }).catch((error) => {
        console.error("Error uploading file: ", error);
        notify.innerHTML = "Error adding sponsor";
    });
}

// Function to clear sponsor input fields
function clearFieldsSponsors() {
    document.querySelector('#title4').value = "";
    document.querySelector('#post_image5').value = ""; // Changed to post_image5
    document.querySelector('#category3').value = ""; 
}

// Function to retrieve sponsor data and display it in the table
function GetSponsorData() {
    const user_ref = ref(db, 'sponsors/');
    get(user_ref).then((snapshot) => {
        const data = snapshot.val();
        let html = "";
        const table = document.querySelector('#Sponsors');

        for (const key in data) {
            const { title, imageURL, category, userName } = data[key];

            html += `
                <tr>
                    <td><span class="postNumber"></span></td>
                    <td class="separator">
                        <div><b>${title}</b></div>
                        <div>Added by: ${userName || "ADMIN"}</div>
                        <img src="${imageURL}" alt="Sponsor Image" class="${category}" style="width:100px;height:100px;">
                    </td>
                    <td class="separator"><button class="delete" onclick="deleteSponsorData('${key}')">Delete</button></td>
                    <td class="separator"><button class="update" onclick="updateSponsorData('${key}')">Update</button></td>
                </tr>
            `;
        }
        table.innerHTML = html;
    });
}

// Function to delete sponsor data
window.deleteSponsorData = function (key) {
    const currentUser = auth.currentUser;
    if (!currentUser) {
        alert("You must be logged in to delete a post.");
        return;
    }

    const user_ref = ref(db, `sponsors/${key}`);
    get(user_ref).then((snapshot) => {
        const data = snapshot.val();
        if (!data) {
            notify.innerHTML = "Sponsor not found";
            return;
        }

        // Check if the current user is the owner of the post
        if (data.userId !== currentUser.uid) {
            alert("You can only delete your own posts.");
            return;
        }

        const imageRef = storageRef(storage, data.imageURL);
        remove(user_ref).then(() => {
            return deleteObject(imageRef);
        }).then(() => {
            notify.innerHTML = "Sponsor and associated image deleted successfully";
            GetSponsorData();
        }).catch((error) => {
            console.error("Error deleting data: ", error);
            notify.innerHTML = "Error deleting sponsor";
        });
    });
}

// Function to update sponsor data
window.updateSponsorData = function (key) {
    const currentUser = auth.currentUser;
    if (!currentUser) {
        alert("You must be logged in to update a post.");
        return;
    }

    const user_ref = ref(db, `sponsors/${key}`);
    get(user_ref).then((item) => {
        const data = item.val();
        if (!data) {
            notify.innerHTML = "Sponsor not found";
            return;
        }

        // Check if the current user is the owner of the post
        if (data.userId !== currentUser.uid) {
            alert("You can only update your own posts.");
            return;
        }

        document.querySelector('#title4').value = data.title;
        document.querySelector('#category3').value = data.category;

        // Display update button and hide add button
        document.querySelector('#update_btn4').style.display = 'block';
        document.querySelector('#post_btn4').style.display = 'none';

        // Bind update functionality
        document.querySelector('#update_btn4').onclick = function() {
            updateSponsorData(key, data.imageURL);
        };
    });
}

// Update sponsor data logic
function updateSponsorData(key, oldImageURL) {
    const title = document.querySelector('#title4').value;
    const post_image5 = document.querySelector('#post_image5').files[0]; // Changed to post_image5
    const category3 = document.querySelector('#category3').value;

    const deleteOldImage = (url) => {
        const oldImageRef = storageRef(storage, url);
        return deleteObject(oldImageRef);
    };

    const uploadNewImage = (file, id) => {
        const newImageRef = storageRef(storage, `sponsors/${id}-${file.name}`);
        return uploadBytes(newImageRef, file).then(snapshot => getDownloadURL(snapshot.ref));
    };

    const promises = post_image5 ? deleteOldImage(oldImageURL).then(() => uploadNewImage(post_image5, key)) : Promise.resolve(oldImageURL);

    promises.then((newImageURL) => {
        return update(ref(db, `sponsors/${key}`), {
            title: title,
            imageURL: newImageURL,
            category: category3
        });
    }).then(() => {
        notify.innerHTML = "Sponsor updated successfully";
        clearFieldsSponsors();
        GetSponsorData();
    }).catch((error) => {
        console.error("Error updating sponsor: ", error);
        notify.innerHTML = "Error updating sponsor";
    });

    document.querySelector('#update_btn4').style.display = 'none';
    document.querySelector('#post_btn4').style.display = 'block';
}

// Add event listener for the post button
document.querySelector('#post_btn4').addEventListener('click', AddSponsor);
// Initial call to load sponsor data
GetSponsorData();




// --------------------------------







// Club Functions
const club_post_btn = document.querySelector('#club_post_btn');
const club_update_btn = document.querySelector('#club_update_btn');

function Add_Club() {
    const title = document.querySelector('#Ctitle').value;
    const description1 = document.querySelector('#description1').value;
    const description2 = document.querySelector('#description2').value;
    const imageR = document.querySelector('#imageR').files[0];
    const imageL = document.querySelector('#imageL').files[0];
    const act1 = document.querySelector('#act1').files[0];
    const act2 = document.querySelector('#act2').files[0];
    const act3 = document.querySelector('#act3').files[0];
    const act_title = document.querySelector('#act_title').value;
    const act_desc = document.querySelector('#act_desc').value;
    const act_title2 = document.querySelector('#act_title2').value;
    const act_desc2 = document.querySelector('#act_desc2').value;
    const act_title3 = document.querySelector('#act_title3').value;
    const act_desc3 = document.querySelector('#act_desc3').value;
    const poster = document.querySelector('#poster').files[0];
    const galleryFiles = [
        document.querySelector('#gal1').files[0],
        document.querySelector('#gal2').files[0],
        document.querySelector('#gal3').files[0],
        document.querySelector('#gal4').files[0],
        document.querySelector('#gal5').files[0],
        document.querySelector('#gal6').files[0],
        document.querySelector('#gal7').files[0],
        document.querySelector('#gal8').files[0]
    ];
    const reach_out = document.querySelector('#reach_out').value;
    const number1 = document.querySelector('#Cnumber1').value;
    const number2 = document.querySelector('#Cnumber2').value;
    const instaURL = document.querySelector('#instaURL').value;
    const insta_id = document.querySelector('#insta_id').value;
    const Email = document.querySelector('#Email').value;

    const user = auth.currentUser;

    if (!user) {
        alert("You must be logged in to add a club.");
        return;
    }

    if (!title || !description1 || !description2 || !imageR || !imageL || !act1 || !act2 || !act3 || !poster) {
        alert("Please fill in all required fields and upload all required images.");
        return;
    }

    const id = Date.now();

    const uploadImages = async (files) => {
        const urls = [];
        for (const file of files) {
            if (!file) continue;
            const imageRef = storageRef(storage, `club_images/${id}-${file.name}`);
            await uploadBytes(imageRef, file);
            const downloadURL = await getDownloadURL(imageRef);
            urls.push(downloadURL);
        }
        return urls;
    };

    Promise.all([
        uploadImages([imageR, imageL, act1, act2, act3, poster, ...galleryFiles])
    ]).then(([imageURLs]) => {
        const [
            imageR_URL, imageL_URL, act1_URL, act2_URL, act3_URL, poster_URL,
            gal1_URL, gal2_URL, gal3_URL, gal4_URL, gal5_URL, gal6_URL, gal7_URL, gal8_URL
        ] = imageURLs;

        return set(ref(db, 'clubs/' + id), {
            title: title,
            description1: description1,
            description2: description2,
            imageR: imageR_URL,
            imageL: imageL_URL,
            activities: [
                { title: act_title, description: act_desc, image: act1_URL },
                { title: act_title2, description: act_desc2, image: act2_URL },
                { title: act_title3, description: act_desc3, image: act3_URL }
            ],
            poster: poster_URL,
            gallery: [gal1_URL, gal2_URL, gal3_URL, gal4_URL, gal5_URL, gal6_URL, gal7_URL, gal8_URL].filter(url => url),
            reach_out: reach_out,
            contact: {
                number1: number1,
                number2: number2,
                instaURL: instaURL,
                insta_id: insta_id,
                Email: Email
            },
            uid: user.uid
        });
    }).then(() => {
        alert("Club added successfully!");
        clearClubFields();
        GetClubData();
    }).catch((error) => {
        console.error("Error adding club: ", error);
        alert("Error adding club. Please check console for details.");
    });
}

function clearClubFields() {
    document.querySelector('#Ctitle').value = "";
    document.querySelector('#description1').value = "";
    document.querySelector('#description2').value = "";
    document.querySelector('#imageR').value = "";
    document.querySelector('#imageL').value = "";
    document.querySelector('#act1').value = "";
    document.querySelector('#act2').value = "";
    document.querySelector('#act3').value = "";
    document.querySelector('#act_title').value = "";
    document.querySelector('#act_desc').value = "";
    document.querySelector('#act_title2').value = "";
    document.querySelector('#act_desc2').value = "";
    document.querySelector('#act_title3').value = "";
    document.querySelector('#act_desc3').value = "";
    document.querySelector('#poster').value = "";
    document.querySelector('#gal1').value = "";
    document.querySelector('#gal2').value = "";
    document.querySelector('#gal3').value = "";
    document.querySelector('#gal4').value = "";
    document.querySelector('#gal5').value = "";
    document.querySelector('#gal6').value = "";
    document.querySelector('#gal7').value = "";
    document.querySelector('#gal8').value = "";
    document.querySelector('#reach_out').value = "";
    document.querySelector('#Cnumber1').value = "";
    document.querySelector('#Cnumber2').value = "";
    document.querySelector('#instaURL').value = "";
    document.querySelector('#insta_id').value = "";
    document.querySelector('#Email').value = "";
}

function GetClubData() {
    const club_ref = ref(db, 'clubs/');
    get(club_ref).then((snapshot) => {
        const data = snapshot.val();
        let html = "";
        const table = document.querySelector('#clubs_table');

        for (const key in data) {
            const club = data[key];
            const username = users[club.uid] || "ADMIN";

            html += `
            <tr>
                <td><span class="clubNumber"></span></td>
                <td class="separator">
                    <div><b>${club.title}</b> by <i>${username}</i></div>
                    <img src="${club.imageR}" alt="Club Image" style="width:100px;height:100px;">
                </td>
                <td class="separator">
                    <button class="delete" onclick="deleteClub('${key}', '${club.uid}')">Delete</button>
                </td>
                <td class="separator">
                    <button class="update" onclick="updateClub('${key}', '${club.uid}')">Update</button>
                </td>
                <td class="separator">
                    <a href="../club-details/index.html?id=${key}" class="details">View Details</a>
                </td>
            </tr>`;
        }
        table.innerHTML = html;
    }).catch((error) => {
        console.error("Error fetching clubs: ", error);
        alert("Error fetching clubs. Please try again.");
    });
}

window.deleteClub = function (key, clubUID) {
    const user = auth.currentUser;
    if (!user) return alert("You must be logged in to delete a club.");
    
    if (user.uid === adminUID || user.uid === clubUID) {
        const club_ref = ref(db, `clubs/${key}`);
        
        get(club_ref).then((snapshot) => {
            const data = snapshot.val();
            const images = [
                data.imageR, 
                data.imageL, 
                ...data.activities.map(act => act.image), 
                data.poster, 
                ...data.gallery
            ].filter(url => url);

            const deletePromises = images.map(url => {
                try {
                    // Properly decode the URL and extract the path
                    const decodedUrl = decodeURIComponent(url);
                    const pathStart = decodedUrl.indexOf('/o/') + 3;
                    const pathEnd = decodedUrl.indexOf('?');
                    const fullPath = decodedUrl.slice(pathStart, pathEnd);
                    
                    // Alternative method using URL object
                    const urlObj = new URL(url);
                    const pathFromUrl = decodeURIComponent(urlObj.pathname);
                    const correctPath = pathFromUrl.replace('/v0/b/' + firebaseConfig.storageBucket + '/o/', '');
                    
                    return deleteObject(storageRef(storage, correctPath));
                } catch (error) {
                    console.warn("Error parsing URL:", url, error);
                    return Promise.resolve(); // Skip invalid URLs
                }
            });

            return Promise.all([
                remove(club_ref),
                ...deletePromises
            ]);
        }).then(() => {
            GetClubData();
            alert("Club deleted successfully!");
        }).catch(error => {
            console.error("Delete error:", error);
            alert("Club data deleted, but some images might not exist. Check console for details.");
        });
    } else {
        alert("You can only delete clubs you created!");
    }
};

window.updateClub = function (key, clubUID) {
    const user = auth.currentUser;
    if (!user) return alert("You must be logged in to update a club.");
    
    if (user.uid === adminUID || user.uid === clubUID) {
        const club_ref = ref(db, `clubs/${key}`);
        
        get(club_ref).then((snapshot) => {
            const data = snapshot.val();
            
            // Populate form fields
            document.querySelector('#Ctitle').value = data.title;
            document.querySelector('#description1').value = data.description1;
            document.querySelector('#description2').value = data.description2;
            document.querySelector('#act_title').value = data.activities[0].title;
            document.querySelector('#act_desc').value = data.activities[0].description;
            document.querySelector('#act_title2').value = data.activities[1].title;
            document.querySelector('#act_desc2').value = data.activities[1].description;
            document.querySelector('#act_title3').value = data.activities[2].title;
            document.querySelector('#act_desc3').value = data.activities[2].description;
            document.querySelector('#reach_out').value = data.reach_out;
            document.querySelector('#Cnumber1').value = data.contact.number1;
            document.querySelector('#Cnumber2').value = data.contact.number2;
            document.querySelector('#instaURL').value = data.contact.instaURL;
            document.querySelector('#insta_id').value = data.contact.insta_id;
            document.querySelector('#Email').value = data.contact.Email;

            club_update_btn.setAttribute('data-key', key);
            club_post_btn.style.display = 'none';
            club_update_btn.style.display = 'block';
        });
    } else {
        alert("You can only update clubs you created!");
    }
};

club_post_btn.addEventListener('click', Add_Club);
club_update_btn.addEventListener('click', () => {
    const key = club_update_btn.getAttribute('data-key');
    // Implement update logic similar to Add_Club but with update() instead of set()
    // You'll need to handle image updates carefully
});

// Initialize clubs
GetClubData();



        </script>

     
</body>
</html>

<style>

/* Base Styles */
:root {
    --primary-color: #4f46e5;
    --primary-hover: #4338ca;
    --secondary-color: #6b7280;
    --success-color: #10b981;
    --danger-color: #ef4444;
    --warning-color: #f59e0b;
    --background-color: #f3f4f6;
    --card-background: #ffffff;
    --text-primary: #111827;
    --text-secondary: #6b7280;
    --border-color: #e5e7eb;
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', sans-serif;
    background-color: var(--background-color);
    color: var(--text-primary);
    line-height: 1.5;
}

/* Login Styles */
.login-container {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    padding: 1rem;
}

.login-box {
    background: var(--card-background);
    padding: 2rem;
    border-radius: 1rem;
    box-shadow: var(--shadow-lg);
    width: 100%;
    max-width: 400px;
}

.login-box h1 {
    text-align: center;
    color: var(--primary-color);
    margin-bottom: 2rem;
    font-size: 1.875rem;
}

.login-form {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

/* Header Styles */
.header {
    background: var(--card-background);
    box-shadow: var(--shadow-sm);
    position: sticky;
    top: 0;
    z-index: 10;
}

.header nav {
    max-width: 1280px;
    margin: 0 auto;
    padding: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.logo {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-weight: 600;
    font-size: 1.25rem;
}

.nav-links {
    display: flex;
    gap: 2rem;
    list-style: none;
}

.nav-links a {
    color: var(--text-secondary);
    text-decoration: none;
    font-weight: 500;
    padding: 0.5rem;
    border-radius: 0.375rem;
    transition: all 0.2s;
}

.nav-links a:hover,
.nav-links a.active {
    color: var(--primary-color);
    background-color: #f3f4f6;
}

/* Main Content Styles */
.main-content {
    max-width: 1280px;
    margin: 2rem auto;
    padding: 0 1rem;
}

.content-section {
    background: var(--card-background);
    border-radius: 0.5rem;
    box-shadow: var(--shadow);
    margin-bottom: 2rem;
}

.section-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.section-header h2 {
    font-size: 1.25rem;
    font-weight: 600;
}

.section-content {
    padding: 1.5rem;
}

/* Form Styles */
.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
}

.form-group {
    margin-bottom: 1rem;
}

.form-group.full-width {
    grid-column: 1 / -1;
}

label {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
}

input,
select,
textarea {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--border-color);
    border-radius: 0.375rem;
    background-color: white;
    color: var(--text-primary);
    font-size: 0.875rem;
    transition: all 0.2s;
}

input:focus,
select:focus,
textarea:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
}

/* Activities Styles */
.activities-container {
    display: grid;
    gap: 1.5rem;
    margin-top: 1rem;
}

.activity-group {
    background: #f9fafb;
    padding: 1rem;
    border-radius: 0.5rem;
    border: 1px solid var(--border-color);
}

/* Gallery Styles */
.gallery-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

/* Image Upload Styles */
.image-upload-container {
    display: grid;
    gap: 1rem;
}

.image-upload {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.image-upload select {
    width: auto;
    min-width: 120px;
}

/* Button Styles */
.btn-toggle,
.btn-submit,
.btn-update,
.btn-login {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 0.375rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-toggle {
    background-color: var(--background-color);
    color: var(--text-secondary);
}

.btn-submit {
    background-color: var(--primary-color);
    color: white;
}

.btn-update {
    background-color: var(--warning-color);
    color: white;
}

.btn-login {
    background-color: var(--primary-color);
    color: white;
    width: 100%;
}

.btn-toggle:hover {
    background-color: #e5e7eb;
}

.btn-submit:hover,
.btn-login:hover {
    background-color: var(--primary-hover);
}

.btn-update:hover {
    background-color: #d97706;
}

/* Table Styles */
.table-container {
    margin-top: 2rem;
    overflow-x: auto;
}

.table-container h3 {
    margin-bottom: 1rem;
    font-size: 1.125rem;
    color: var(--text-secondary);
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th,
.data-table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
}

.data-table th {
    background-color: #f9fafb;
    font-weight: 500;
    color: var(--text-secondary);
}

.data-table tr:hover {
    background-color: #f9fafb;
}

/* Footer Styles */
.footer {
    background-color: #1f2937;
    color: white;
    padding: 3rem 1rem;
    text-align: center;
    margin-top: 4rem;
}

.footer h4 {
    font-size: 1.5rem;
    margin-bottom: 1rem;
}

.social-links {
    display: flex;
    justify-content: center;
    gap: 1.5rem;
    margin: 1.5rem 0;
}

.social-link {
    color: white;
    text-decoration: none;
    opacity: 0.8;
    transition: opacity 0.2s;
}

.social-link:hover {
    opacity: 1;
}

.copyright {
    opacity: 0.6;
    font-size: 0.875rem;
}

/* Utility Classes */
.hidden {
    display: none;
}

.subsection-title {
    color: var(--text-secondary);
    font-size: 1.125rem;
    margin: 1.5rem 0 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border-color);
}

/* Animation for Blinking Text */
@keyframes blink {
    from {
        opacity: 1;
    }
    to {
        opacity: 0;
    }
}

.blinking {
    animation: blink 1s infinite alternate;
}

/* Responsive Design */
@media (max-width : 768px) {
    .nav-links {
        display: none;
    }
    
    .form-grid {
        grid-template-columns: 1fr;
    }
    
    .section-header {
        flex-direction: column;
        gap: 1rem;
    }
    
    .btn-toggle {
        width: 100%;
    }

    .image-upload {
        flex-direction: column;
        align-items: stretch;
    }

    .image-upload select {
        width: 100%;
    }

    .gallery-grid {
        grid-template-columns: repeat(2, 1fr);
    }

    .activities-container {
        grid-template-columns: 1fr;
    }

    .social-links {
        flex-direction: column;
        gap: 1rem;
    }
}

@media (max-width: 480px) {
    .login-box {
        padding: 1.5rem;
    }

    .gallery-grid {
        grid-template-columns: 1fr;
    }

    .data-table {
        font-size: 0.875rem;
    }

    .data-table th,
    .data-table td {
        padding: 0.5rem;
    }

    .btn-submit,
    .btn-update {
        width: 100%;
        margin-bottom: 0.5rem;
    }
}

</style>